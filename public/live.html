<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Setlist - NeoN VJ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap');
        body { font-family: 'Inter', sans-serif; }
        
        .pulse-dot {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen">
    <!-- Header -->
    <header class="bg-black/50 backdrop-blur-sm border-b border-gray-800 sticky top-0 z-10">
        <div class="container mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <div>
                    <h1 id="eventName" class="text-xl font-semibold">Loading...</h1>
                    <div class="flex items-center gap-2 text-sm text-gray-400">
                        <span class="inline-block w-2 h-2 bg-red-500 rounded-full pulse-dot"></span>
                        <span>LIVE</span>
                        <span>‚Ä¢</span>
                        <span id="songCount">0 songs</span>
                        <span>‚Ä¢</span>
                        <span id="currentTime">--:--</span>
                    </div>
                </div>
                <button onclick="shareEvent()" 
                        class="px-4 py-2 bg-purple-600 hover:bg-purple-700 rounded-lg text-sm font-medium transition">
                    Share
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-6 max-w-2xl">
        <!-- DJ Filter -->
        <div class="mb-6">
            <select id="djFilter" 
                    onchange="filterByDJ()"
                    class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white">
                <option value="all">All DJs</option>
            </select>
        </div>

        <!-- Event URL (if provided) -->
        <div id="eventUrlSection" class="mb-6 hidden">
            <a id="eventUrl" href="#" target="_blank" rel="noopener noreferrer"
               class="text-purple-400 hover:text-purple-300 text-sm">
                üåê <span id="eventUrlText"></span>
            </a>
        </div>

        <!-- Setlist Container -->
        <div id="setlistContainer" class="space-y-2">
            <!-- Songs will be inserted here -->
        </div>

        <!-- Loading State -->
        <div id="loadingState" class="text-center py-12">
            <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-purple-400"></div>
            <p class="text-gray-400 mt-4">Loading setlist...</p>
        </div>

        <!-- Empty State -->
        <div id="emptyState" class="text-center py-12 hidden">
            <p class="text-gray-400">No songs played yet. Waiting for the first track...</p>
        </div>

        <!-- Notice -->
        <div class="mt-8 bg-yellow-900/20 border border-yellow-800 rounded-lg p-4">
            <p class="text-yellow-200 text-sm">
                ‚ö†Ô∏è Some tracks may not appear if recognition was unsuccessful<br>
                üóìÔ∏è This page will be automatically deleted after 30 days
            </p>
        </div>
    </main>

    <!-- Footer -->
    <footer class="mt-auto border-t border-gray-800 bg-black/50">
        <div class="container mx-auto px-4 py-6 text-center">
            <p class="text-gray-400 text-sm">
                Powered by NeoN VJ
            </p>
            <p class="text-gray-500 text-xs mt-1">
                ¬© 2025 SMYLE | Produced by NeoN
            </p>
        </div>
    </footer>

    <script>
        // Configuration
        const UPDATE_INTERVAL = 30000; // 30 seconds
        let eventId = null;
        let eventData = null;
        let songs = [];
        let updateTimer = null;
        
        // Initialize
        window.addEventListener('DOMContentLoaded', () => {
            // Get event ID from URL
            const pathParts = window.location.pathname.split('/');
            eventId = pathParts[pathParts.length - 1];
            
            if (eventId) {
                loadEventData();
                updateTimer = setInterval(loadEventData, UPDATE_INTERVAL);
                updateCurrentTime();
                setInterval(updateCurrentTime, 1000);
            }
        });
        
        // Load event data from JSON
        async function loadEventData() {
            try {
                const response = await fetch(`/data/events/${eventId}.json`);
                if (!response.ok) throw new Error('Event not found');
                
                const data = await response.json();
                eventData = data.event;
                songs = data.songs || [];
                
                updateUI();
            } catch (error) {
                console.error('Failed to load event data:', error);
                document.getElementById('loadingState').innerHTML = `
                    <p class="text-red-400">Event not found or expired</p>
                `;
            }
        }
        
        // Update UI with event data
        function updateUI() {
            // Hide loading state
            document.getElementById('loadingState').classList.add('hidden');
            
            // Update event info
            document.getElementById('eventName').textContent = eventData.name || 'Live Event';
            document.getElementById('songCount').textContent = `${songs.length} songs`;
            
            // Update event URL if exists
            if (eventData.event_url) {
                document.getElementById('eventUrlSection').classList.remove('hidden');
                document.getElementById('eventUrl').href = eventData.event_url;
                document.getElementById('eventUrlText').textContent = eventData.event_url;
            }
            
            // Update DJ filter
            updateDJFilter();
            
            // Display songs
            displaySongs();
        }
        
        // Update DJ filter options
        function updateDJFilter() {
            const djSet = new Set(songs.map(s => s.dj_name));
            const djFilter = document.getElementById('djFilter');
            
            // Keep "All DJs" option
            djFilter.innerHTML = '<option value="all">All DJs</option>';
            
            // Add DJ options
            djSet.forEach(dj => {
                const option = document.createElement('option');
                option.value = dj;
                option.textContent = dj;
                djFilter.appendChild(option);
            });
        }
        
        // Display songs based on filter
        function displaySongs() {
            const container = document.getElementById('setlistContainer');
            const filter = document.getElementById('djFilter').value;
            
            // Filter songs
            let filteredSongs = songs;
            if (filter !== 'all') {
                filteredSongs = songs.filter(s => s.dj_name === filter);
            }
            
            // Show empty state if no songs
            if (filteredSongs.length === 0) {
                document.getElementById('emptyState').classList.remove('hidden');
                container.innerHTML = '';
                return;
            }
            
            document.getElementById('emptyState').classList.add('hidden');
            
            // Display mode based on event settings
            const displayMode = eventData.dj_display_mode || 'chronological';
            
            if (displayMode === 'grouped') {
                displaySongsGrouped(filteredSongs);
            } else {
                displaySongsChronological(filteredSongs);
            }
        }
        
        // Display songs in chronological order
        function displaySongsChronological(songList) {
            const container = document.getElementById('setlistContainer');
            container.innerHTML = '';
            
            // Sort by timestamp (newest first)
            const sortedSongs = [...songList].reverse();
            
            sortedSongs.forEach((song, index) => {
                const songEl = createSongElement(song, index === 0);
                container.appendChild(songEl);
            });
        }
        
        // Display songs grouped by DJ
        function displaySongsGrouped(songList) {
            const container = document.getElementById('setlistContainer');
            container.innerHTML = '';
            
            // Group songs by DJ
            const groups = {};
            songList.forEach(song => {
                if (!groups[song.dj_name]) {
                    groups[song.dj_name] = [];
                }
                groups[song.dj_name].push(song);
            });
            
            // Display each group
            Object.entries(groups).forEach(([djName, djSongs]) => {
                // DJ header
                const header = document.createElement('div');
                header.className = 'bg-purple-900/20 rounded-lg px-4 py-2 mt-4 mb-2';
                header.innerHTML = `<h3 class="font-semibold">üéß ${djName}</h3>`;
                container.appendChild(header);
                
                // DJ's songs
                djSongs.reverse().forEach((song, index) => {
                    const songEl = createSongElement(song, false, true);
                    container.appendChild(songEl);
                });
            });
        }
        
        // Create song element
        function createSongElement(song, isLatest = false, hideDJ = false) {
            const div = document.createElement('div');
            div.className = `bg-gray-800/50 rounded-lg p-4 ${isLatest ? 'border border-purple-500 fade-in' : ''}`;
            
            const djText = hideDJ ? '' : ` (${song.dj_name})`;
            const timeStr = new Date(song.timestamp).toLocaleTimeString('ja-JP', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            
            div.innerHTML = `
                <div class="flex justify-between items-start">
                    <div class="flex-1">
                        <div class="font-medium">${song.title}${djText}</div>
                        <div class="text-gray-400 text-sm mt-1">${song.artist}</div>
                    </div>
                    <div class="text-gray-500 text-xs">${timeStr}</div>
                </div>
                ${isLatest ? '<div class="text-purple-400 text-xs mt-2">üéµ Now Playing</div>' : ''}
            `;
            
            return div;
        }
        
        // Filter by DJ
        function filterByDJ() {
            displaySongs();
        }
        
        // Share event
        async function shareEvent() {
            const url = window.location.href;
            
            if (navigator.share) {
                try {
                    await navigator.share({
                        title: eventData.name || 'NeoN VJ Live Setlist',
                        text: 'Check out this live setlist!',
                        url: url
                    });
                } catch (err) {
                    copyToClipboard(url);
                }
            } else {
                copyToClipboard(url);
            }
        }
        
        // Copy to clipboard
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                alert('URL copied to clipboard!');
            });
        }
        
        // Update current time
        function updateCurrentTime() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('ja-JP', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            document.getElementById('currentTime').textContent = timeStr;
        }
        
        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (updateTimer) {
                clearInterval(updateTimer);
            }
        });
    </script>
</body>
</html>